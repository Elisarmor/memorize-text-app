<svelte:window on:keydown="keydown(event)" />

<div class=container>
	<div class=content>
		<h1 style="font-size: 1rem; text-align: center;">{displayHeader}</h1>

		{#if sheet.rows.length === 0}
			<h2>
				This sheet doesn't have any rows!
			</h2>
		{:else}
			<div class="box">
				<strong>
					{currentCard.prompt}
				</strong>
			</div>

			<div class="box">
				{visibleAnswer}<span
					data-hidden={hintLevel === 0 || !wordsAreLeftToDisplay}
					style="color: var(--gray);"
				>…</span>

				<span style="visibility: hidden">
					{hiddenAnswer}
				</span>
			</div>
		{/if}
	</div>

	<div class=footer>
		<div class=footer-left>
			<a href={ asr.makePath('index') }>Home</a>
		</div>
		<div class="faint footer-center">
			<span class=key-identifier>[Spacebar]</span> Advance
			·
			<span class=key-identifier>h</span> Show more hint
		</div>
		<div class="faint footer-right nowrap">
			{currentQuestionPosition + 1} / {cardsInSheet}
		</div>
	</div>
</div>

<style>

[data-hidden=true] {
	visibility: hidden;
}

.key-identifier {
	font-family: sans-serif;
	background-color: var(--gray);
	color: var(--white);
	padding: 2px 4px;
	border-radius: 2px;
}

.faint {
	color: var(--lightBlack);
}

.box {
	padding: 32px;
	margin: 32px 8px;
	border-radius: 5px;
	box-shadow: 0 0 8px 4px var(--lightGray);
}

.footer {
	display: flex;
	justify-content: space-between;
}
@media (max-width: 600px) {
	.footer {
		flex-direction: column;
	}
	.footer * {
		flex-basis: 1.8rem;
	}
}

.footer * {
	text-align: center;
}
.footer-center {
	flex-grow: 1;
}
.footer-left, .footer-right {
	flex-basis: 64px;
}
.nowrap {
	white-space: nowrap;
}

</style>

<script>
export default {
	data() {
		return {
			currentQuestionPosition: 0,
			sheet: null,
			answerIsFullyVisible: false,
			hintLevel: 0,
		}
	},
	computed: {
		currentCard: ({ currentQuestionPosition, sheet }) => {
			const row = sheet.rows[currentQuestionPosition]

			return row
				? {
					prompt: row[0],
					answer: row[1],
				}
				: null
		},
		cardsInSheet: ({ sheet }) => sheet.rows.length,
		displayHeader: ({ sheet, workbook }) => sheet.name === `Sheet1`
			? workbook.name
			: `${ workbook.name } · ${ sheet.name }`,
		answerWords: ({ currentCard }) => currentCard.answer.split(/\s+/g),
		numberOfHintWords: ({ hintLevel }) => {
			if (hintLevel === 0) {
				return 0
			}

			return 3 + ((hintLevel - 1) * 5)
		},
		visibleAnswer: ({ answerIsFullyVisible, currentCard, answerWords, numberOfHintWords }) => answerIsFullyVisible
			? currentCard.answer
			: answerWords.slice(0, numberOfHintWords).join(` `),
		hiddenAnswer: ({ answerIsFullyVisible, answerWords, numberOfHintWords }) => answerIsFullyVisible
			? ``
			: answerWords.slice(numberOfHintWords).join(` `),
		wordsAreLeftToDisplay: ({ answerIsFullyVisible, numberOfHintWords, answerWords }) => !answerIsFullyVisible
			&& numberOfHintWords < answerWords.length,
	},
	methods: {
		goToNextCard() {
			const { currentQuestionPosition, cardsInSheet } = this.get()
			const incrementedPosition = currentQuestionPosition + 1

			this.set({
				currentQuestionPosition: incrementedPosition >= cardsInSheet ? 0 : incrementedPosition,
				answerIsFullyVisible: false,
				hintLevel: 0,
			})
		},
		keydown({ key }) {
			if (key === ` `) {
				if (this.get().answerIsFullyVisible) {
					this.goToNextCard()
				} else {
					this.set({
						answerIsFullyVisible: true,
					})
				}
			} else if (key === `h` || key === `H`) {
				this.set({
					hintLevel: this.get().hintLevel + 1,
				})

				if (!this.get().wordsAreLeftToDisplay) {
					this.set({
						answerIsFullyVisible: true,
					})
				}
			}
		},
	},
}
</script>
